# ===============================
#  OpenClash (Clash.Meta) config
#  Region-scoped Load-Balance
# ===============================

# --- Ports ---
port: 9794
socks-port: 9795
mixed-port: 9796
redir-port: 9797
tproxy-port: 9898

allow-lan: true
bind-address: '*'
find-process-mode: always
mode: rule
log-level: error

ipv6: true
keep-alive-interval: 30
tcp-concurrent: true
inbound-tfo: true
unified-delay: true

global-ua: "Mozilla/5.0 (Linux; Android 14; Pixel 7 Build/AP2A.240705.004; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/126.0.6478.8 Mobile Safari/537.36"
global-client-fingerprint: chrome

external-controller: 0.0.0.0:9090
external-ui: /usr/share/openclash/ui

profile:
  store-fake-ip: true
  store-selected: true

# ----- Anchors (preset LB/HC) -----
anchor:
  gen204: &gen204 'https://www.gstatic.com/generate_204'
  t: &t {url: *gen204, interval: 3600, tolerance: 50, lazy: true, timeout: 5, success-code: 204, expected-status: 204}
  lb: &lb {type: load-balance, strategy: consistent-hashing, url-test: *t, <<: *t}
  fb: &fb {type: fallback, <<: *t}
  ut: &ut {type: url-test, <<: *t}
  pp: &pp {health-check: {enable: true, lazy: false, <<: *t}}

# ----- Hosts -----
hosts:
  rule-set:personal: 127.0.0.1

# ----- DNS -----
dns:
  enable: true
  cache-algorithm: arc
  ipv6: true
  prefer-h3: true
  use-hosts: true
  use-system-hosts: false
  listen: 0.0.0.0:1053
  respect-rules: false

  nameserver:
    - 'quic://unfiltered.adguard-dns.com#GLOBAL'

  default-nameserver:
    - 'tcp://94.140.14.140#GLOBAL'

  proxy-server-nameserver:
    - 'tcp://112.215.198.254:53#DIRECT'
    - 'tcp://112.215.198.248:53#DIRECT'

  nameserver-policy:
    rule-set:personal: rcode://success

  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - dns.msftnsci.com
    - www.msftnsci.com
    - www.msftconnecttest.com
    - time.android.com
    - lens.l.google.com
    - stun.l.google.com
    - global.stun.twilio.com
    - stun.nextcloud.com
    - stun.cloudflare.com
    - stun.voip.blackberry.com

  fallback: []
  fallback-filter: {}

# ----- SNIFFER -----
sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  override-destination: false
  sniff:
    TLS: {ports: [443, 8443]}
    HTTP: {ports: [80, 8080-8880], override-destination: true}
  sniffing: [tls, http]

# ----- TUN (OpenWrt) -----
tun:
  enable: true
  stack: system     # system/gvisor
  mtu: 1500
  dns-hijack:
    - any:53
    - tcp://any:53
  auto-route: true
  auto-detect-interface: true

# ===============================
# PROVIDERS (file terpisah per region)
# ===============================
proxy-providers:
  pp_id:
    <<: *pp
    type: file
    path: ./proxy_provider/fadzWRT-id.yaml
  pp_sg:
    <<: *pp
    type: file
    path: ./proxy_provider/fadzWRT-sg.yaml

proxies: []

# ===============================
# GROUPS
# ===============================
proxy-groups:
  # Util
  - {name: ADS, type: select, proxies: [REJECT, GLOBAL], default: REJECT}
  - {name: QUIC, type: select, proxies: [REJECT, GLOBAL], default: REJECT}

  # Selector manual per-region (pilih node tertentu)
  - name: INDONESIA
    type: select
    use: [pp_id]

  - name: SINGAPORE
    type: select
    use: [pp_sg]

  # Load-Balance per-region
  - name: LB-ID
    <<: *lb
    use: [pp_id]
    exclude-filter: "âš ï¸"

  - name: LB-SG
    <<: *lb
    use: [pp_sg]
    exclude-filter: "âš ï¸"

  # Load-Balance gabungan
  - name: BALANCE-ALL
    <<: *lb
    use: [pp_id, pp_sg]
    exclude-filter: "âš ï¸"

  # (Opsional) Grup OTHER untuk pool non-ID/SG jika nanti ditambah
  - name: OTHER
    type: select
    include-all-providers: true
    exclude-filter: "(ðŸ‡®ðŸ‡©|\\bID\\b|Indonesia|JKT|Jakarta|ðŸ‡¸ðŸ‡¬|\\bSG\\b|Singapore|SGP|SG-|SG\\d)"

  # Master switch
  - name: GLOBAL
    type: select
    proxies:
      - LB-ID
      - LB-SG
      - BALANCE-ALL
      - INDONESIA
      - SINGAPORE
      - OTHER
    default: BALANCE-ALL

# ===============================
# RULE PROVIDERS
# ===============================
rule-providers:
  category-ads-all:
    type: http
    behavior: domain
    url: 'https://raw.githubusercontent.com/tonggaret/dlc-geosite/subscribe/category-ads-all/category-ads-all'
    path: ./rule_provider/category-ads-all.yaml
    interval: 86400
    format: text

  personal:
    type: file
    behavior: domain
    path: ./rules/personal.yaml

# ===============================
# RULES
# ===============================
rules:
  - RULE-SET,personal,REJECT
  - RULE-SET,category-ads-all,ADS
  - AND,((NETWORK,udp),(DST-PORT,443)),QUIC
  - MATCH,GLOBAL
